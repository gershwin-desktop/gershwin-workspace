only_if: $CIRRUS_BRANCH == 'main' && $CIRRUS_PR == ''

trigger_ports_build_task:
  name: "Trigger ports build"
  container:
    image: curlimages/curl:latest
  
  trigger_script:
    - |
      curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        -d '{
          "event_type": "workspace_merge",
          "client_payload": {
            "workspace_commit": "'$CIRRUS_CHANGE_IN_REPO'",
            "workspace_branch": "'$CIRRUS_BRANCH'",
            "triggered_by": "gershwin-workspace"
          }
        }' \
        "https://api.github.com/repos/gershwin-desktop/gershwin-unstable-ports/dispatches"
  
  env:
    GITHUB_TOKEN: ENCRYPTED[771de1ce213dbda78174b8c9b649b86e120316b8837de579acfa3d3e077d948197d90b1da4cd2fa6e64e4b8d03a57538]
